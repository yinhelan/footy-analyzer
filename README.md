# Footy Analyzer V1（自用竞彩足球分析工具）

## 产品定位
- 用途：自用竞彩足球分析（稳健风格）
- 玩法：胜平负（V1.1 预留让球胜平负）
- 下注结构：串关为主
- 预算：每晚一轮 100 RMB
- 博冷：仅在满足信号时触发（默认最多 10 RMB）

## Phase 0：约束与验收标准

### 约束
- 仅本地运行（无服务器依赖）
- 不抓取外网数据（V1 只解析用户粘贴文本）
- 输出必须是一段可一键复制纯文本
- UI 简洁，手机/电脑自适配
- 所有历史保存到 localStorage

### 验收标准
1. `pnpm dev` 后能打开页面
2. 粘贴 2–8 行比赛文本后可解析并生成建议
3. 一键复制输出成功
4. 历史记录可保存/加载/删除
5. 缺字段不崩溃，输出用“—”兜底

---

## 技术方案（固定）
- Vite + React + TypeScript
- React Hooks 管理状态
- localStorage 做持久化
- 输出区 `<pre>` + Clipboard API 复制
- 解析器容错处理半结构化中文文本

项目名：`footy-analyzer`

---

## 快速运行
```bash
cd footy-analyzer
pnpm install
pnpm dev
```

打开浏览器访问（通常）：`http://localhost:5173`

---

## 自测命令
```bash
pnpm selftest
```

预期：
- 解析场次 = 2
- 输出包含两场标题、推荐、风险、预算模块
- 布伦特福德 vs 阿森纳 触发条件博冷

---

## 输入格式示例

### 极简版（仅队名）
```text
马德里竞技 vs 巴塞罗那
布伦特福德 vs 阿森纳
```

### 完整版（推荐）
```text
马德里竞技 vs 巴塞罗那 成交价主 2.82 | 平 4.10 | 客 2.50 交易量主 301198 | 平 103703 | 客 739440 占比主 26.3% | 平 9.1% | 客 64.6% 总交易量 1144341 盈亏主 294963 | 平 719159 | 客 -704259
布伦特福德 vs 阿森纳 成交价主 5.70 | 平 4.10 | 客 1.73 交易量主 172064 | 平 57869 | 客 1656780 占比主 9.1% | 平 3.1% | 客 87.8% 总交易量 1886713 盈亏主 905948 | 平 1649450 | 客 -979516 冷热主 -51 | 平 -87 | 客 55
```

---

## 策略规则（V1）
1. **主推荐**：默认取“交易占比最大”方向（主/平/客）
2. **风险升高条件**：
   - 热门拥挤：占比 >= 80%
   - 热度极值：|冷热| >= 50
   - 庄家在推荐方向负盈亏
3. **仓位（u）**：
   - 低风险：1u
   - 中风险：0.5u（若拥挤则 0.75u）
   - 高风险：0.25u
4. **条件博冷（防平）**：
   - 当“热门拥挤或很热”且“庄家在热门方向负盈亏”时触发
   - 金额默认 10 RMB
5. **预算模块（100 RMB）**：
   - 主串：风险最低 2 场做 2串1 = 70
   - 机动：风险最低单场 = 20
   - 条件博冷：触发才下 = 10，否则留空

可配置点（后续可改）：阈值（80/50）、各风险仓位、预算分配。

---

## 已知限制
- 仅解析用户粘贴文本，不联网抓数据
- 目前为胜平负，不计算真实赔率收益率
- 输入字段命名过于异常时，可能只能解析出队名

---

## V1.2 当前进度（复盘增强）
- 导出：支持历史记录导出 `.txt`
- 历史筛选：支持日期（今天/近7天/全部）+ 关键词（队名）
- 历史回放：加载历史时同步恢复“输入+参数+输出”
- 历史对比：支持勾选两条结构化对比；勾选一条时自动匹配同场最近两条
- v3.8 硬规则：可在面板启用“硬规则审计模式”（停机协议/数据索取清单/压力审计输出）
- v3.8 裁决链：已接入 B层压力分段 + C0~C11 优先级规则 + D层联赛校准解释标签（EPL/UCL/LaLiga）
- v3.8 可视化：每场输出“决定性规则（优先级#）”、Top3 规则、以及决定性规则一句话解释
- 解释双模式：自动按端侧切换（移动端短版标签风格，桌面端长版2句）
- 移动端短版：固定3标签（#规则 #风险 #ratio），并追加到关键证据首条
- 标签映射可配置：面板可编辑常用规则（B1/C1/C8/C9），未配置规则回退默认标签
- 预设档：支持两档一键应用（稳健/激进），应用后仍可手动微调
- 变更提示：预设应用与手动编辑都会显示顶部短提示（toast）
- Toast 机制：500ms 去抖合并、统一文案、队列上限5条
- Toast 分级：成功/警告/错误（颜色+图标：✓ / ! / ✕）
- 快速修复：解析场次=0 或硬规则停机时，显示修复提示块 + “填入示例”按钮
- 硬规则停机时会自动识别“缺失/可疑字段”（如 T缺失、快照不足）并在提示块显示
- 支持“填入动态模板”：按缺失字段生成最小可运行模板（多行），一键覆盖输入框
- 动态模板可继承最近一次成功解析的队名/联赛/T；继承失败回退为“主队 vs 客队 / EPL”
- 多场支持：修复提示块可下拉选择“第N场”作为动态模板继承对象（默认第1场）
- 点击“生成”时，按当前第N场实时判定缺失/可疑字段，并同步更新warn toast与修复建议
- warn toast 与修复提示块均显示“动态修复顺序”（按命中缺失项自动生成）
- 分步一键补齐：支持“补T/快照 / 补V_total / 补H_fav/PL_fav”，并标记已完成步骤
- 回退/重做：支持“撤销一步 / 重做一步”按钮 + Ctrl/Cmd+Z / Ctrl(Cmd)+Shift+Z（双栈长度各5）
- 按钮支持悬浮提示（title）+ 自定义tooltip + 淡灰快捷键状态提示（含“无可撤销/无可重做”）
- 点击不可用撤销/重做按钮会给出warn toast原因说明
- i18n：支持 zh/en，默认自动跟随浏览器语言，可手动切换并写入 localStorage
- 已覆盖：页面主要静态UI文案 + engine 常规输出 + v3.8 审计输出 + compare对比输出 + 历史导出TXT（标题与正文按当前语言重算）
- 导出fallback提醒：重算失败时显示warn toast + 顶部短横幅；支持“查看详情/收起”、复制错误摘要、复制完整诊断包、复制脱敏诊断包、手动关闭
- 脱敏UA支持级别切换：
  - Level A: 浏览器家族+主版本+OS
  - Level B: Level A + 设备类型（Desktop/Mobile）
- 诊断包 Session Meta 写入 `maskLevel`（完整包=none，脱敏包=A/B）
- maskLevel 持久化到 localStorage（默认A；非法值自动清理并回退A）
- maskLevel 控件统一为主面板输出区单入口（详情区用同款徽标只读显示当前级别）
- 徽标颜色区分：A=灰，B=蓝，并提供 title 提示（Level A safer / Level B more info）
- 主面板与详情区图例支持折叠/展开（默认展开），并全局同步
- 图例开关使用轻量链接样式（灰色低干扰，hover 下划线）
- 图例开关采用轻量链接样式，hover 下划线
- 按钮交互过渡统一：全站按钮启用 `color` 过渡（180ms, ease-out）
- 全站 `button:focus-visible` 统一为 2px 灰蓝 `box-shadow` 光晕（link-btn 复用全局焦点样式）
- 图例显示状态持久化到 localStorage（非法值回退为展开）
- 主面板显示提示：当前级别会影响“复制脱敏诊断包”
- 语言完整性：英文输出已清理预算/让球等关键段落的中文混排，并在 selftest 增加黑名单+中文占比校验

## V1.1 当前进度（增强版）
- 已支持字段：
  - `handicapLine`（如 -0.25）
  - `handicapOdds`（让胜/让平/让负）
- parser 已支持识别：
  - `让球 -0.75`
  - `让胜/让平/让负 1.95/3.50/3.60`
- engine 已支持：
  - 让球独立风险阈值（让球拥挤/热度）
  - 让球推荐仅在风险≤中时输出
  - 让球独立预算（默认额外 50 RMB，不挤占主预算100）
  - 让球开关（可视化面板）

## 可视化面板新增项
- 启用让球推荐（开/关）
- 让球拥挤阈值
- 让球热度阈值
- 让球独立预算
